version: '3.9'

services:
  # ── Redis (local dev) ──────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: flowboard-redis
    ports:
      - '6379:6379'
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - flowboard-net

  # ── Backend Server ─────────────────────────────────────────────────────────
  server:
    build:
      context: ./apps/server
      dockerfile: Dockerfile
    container_name: flowboard-server
    ports:
      - '8080:8080'
    environment:
      NODE_ENV: development
      PORT: 8080
      CORS_ORIGIN: http://localhost:5173
      REDIS_URL: redis://redis:6379
      # Override these in a .env file or via docker-compose.override.yml:
      DATABASE_URL: ${DATABASE_URL}
      REDIS_TOKEN: ${REDIS_TOKEN:-}
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./apps/server/src:/app/src:ro
    networks:
      - flowboard-net
    restart: unless-stopped

  # ── Frontend (Vite dev server) ─────────────────────────────────────────────
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: flowboard-web
    ports:
      - '5173:5173'
    environment:
      VITE_WS_URL: ws://localhost:8080
      VITE_API_URL: http://localhost:8080
    depends_on:
      - server
    volumes:
      - ./apps/web/src:/app/src:ro
    networks:
      - flowboard-net
    restart: unless-stopped

volumes:
  redis-data:

networks:
  flowboard-net:
    driver: bridge
